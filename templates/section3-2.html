{% extends "base.html" %}
{% block content %}

<head>
    
    <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
</head>

<h2>âš™ï¸ Section 3-2: ì˜¤ë¦¬í”¼ìŠ¤ ì‚¬ì´ì§• ê³„ì‚°ê¸° (CoolProp ì—°ë™)</h2>

<p>í•„ìš”í•œ ìœ ëŸ‰(mÌ‡)ê³¼ ì°¨ì••(Î”P)ì„ ì…ë ¥í•˜ê³ , ìœ ì²´ ì„±ë¶„/ì˜¨ë„/ì••ë ¥ ê¸°ë°˜ ë¬¼ì„±ìœ¼ë¡œ ì˜¤ë¦¬í”¼ìŠ¤ ì§ê²½(d)ì„ ê³„ì‚°í•©ë‹ˆë‹¤.</p>

<form method="POST" class="form-container">
    <fieldset>
        <legend>1. ìœ ì²´ ì¡°ê±´ ì…ë ¥ (CoolProp)</legend>
        <div id="components-area" class="input-group">
            {% for i in range(component_count|default(1)) %}
            <div class="component-row">
                <label>Component:</label>
                <select name="component">
                    {% for comp in components %}
                        <option value="{{ comp }}"
                            {% if comp == request.form.getlist('component')[i] %}selected{% endif %}>
                            {{ comp }}
                        </option>
                    {% endfor %}
                </select>

                <label>Mole Fraction:</label>
                <input type="number" name="mole_fraction" step="any" min="0" max="1" required
                       value="{{ request.form.getlist('mole_fraction')[i] if request.form.getlist('mole_fraction') else '' }}">

                <button type="button" class="remove-btn" onclick="removeComponent(this)">â–</button>
            </div>
            {% endfor %}
        </div>
        <button type="button" onclick="addComponent()">â• ì„±ë¶„ ì¶”ê°€</button>

        <div class="input-group">
            <label>ì˜¨ë„ (Â°C):</label>
            <input type="number" name="T" step="any" required placeholder="ì˜ˆ) -10"
                   value="{{ request.form.get('T', '') }}">

            <label>ì••ë ¥ (barG):</label>
            <input type="number" name="P" step="any" required placeholder="ì˜ˆ) 5"
                   value="{{ request.form.get('P', '') }}">
        </div>
    </fieldset>

    <fieldset>
        <legend>2. ìœ ëŸ‰ ë° ë°°ê´€ ì¡°ê±´ ì…ë ¥</legend>
        <div class="input-group">
            <label>ëª©í‘œ ì§ˆëŸ‰ ìœ ëŸ‰ (kg/h):</label>
            <input type="number" name="mass_flow_rate" step="any" required
                   value="{{ request.form.get('mass_flow_rate', '') }}">

            <label>ì°¨ì•• (barG):</label>
            <input type="number" name="delta_p" step="any" required
                   value="{{ request.form.get('delta_p', '') }}">

            <label>ë°°ê´€ ë‚´ê²½ D (mm):</label>
            <input type="number" name="pipe_diameter" step="any" required
                   value="{{ request.form.get('pipe_diameter', '') }}">
        </div>

        <button type="submit" class="submit-btn">ğŸ“ ì˜¤ë¦¬í”¼ìŠ¤ ê³„ì‚°í•˜ê¸°</button>
    </fieldset>
</form>

<hr>

{% if result %}
    <h3>ğŸ“„ ê³„ì‚° ê²°ê³¼</h3>
    {% if result.error %}
        <p style="color: red;">âš ï¸ ì˜¤ë¥˜: {{ result.error }}</p>
    {% else %}
        <table class="result-table">
            <thead>
                <tr>
                    <th>í•­ëª©</th>
                    <th>ê°’</th>
                    <th>ë‹¨ìœ„</th>
                </tr>
            </thead>
            <tbody>
                <tr><td>ì˜¤ë¦¬í”¼ìŠ¤ ì§ê²½ (d)</td><td>{{ "{:.2f}".format(result.orifice_diameter_mm) }}</td><td>mm</td></tr>
                <tr><td>Î² (d/D)</td><td>{{ "{:.4f}".format(result.beta) }}</td><td>-</td></tr>
                <tr><td>ë””ìŠ¤ì°¨ì§€ ê³„ìˆ˜ (C)</td><td>{{ "{:.5f}".format(result.discharge_coefficient) }}</td><td>-</td></tr>
                <tr><td>Reynolds ìˆ˜ (Re_D)</td><td>{{ "{:.2e}".format(result.reynolds_number) }}</td><td>-</td></tr>
                <tr><td>ë°€ë„ (Ï)</td><td>{{ "{:.2f}".format(result.density) }}</td><td>kg/mÂ³</td></tr>
                <tr><td>ì ë„ (Î¼)</td><td>{{ "{:.4e}".format(result.viscosity) }}</td><td>PaÂ·s</td></tr>
            </tbody>
        </table>
    {% endif %}
{% endif %}

<script>
const COMPONENTS = {{ components | tojson }};

function addComponent() {
    const area = document.getElementById('components-area');
    const row = document.createElement('div');
    row.className = 'component-row';

    let options = '';
    COMPONENTS.forEach(comp => {
        options += `<option value="${comp}">${comp}</option>`;
    });

    row.innerHTML = `
        <label>Component:</label>
        <select name="component">${options}</select>
        <label>Mole Fraction:</label>
        <input type="number" name="mole_fraction" step="any" min="0" max="1" required>
        <button type="button" class="remove-btn" onclick="removeComponent(this)">â–</button>
    `;
    area.appendChild(row);
}

function removeComponent(button) {
    const row = button.parentElement;
    row.remove();
}
</script>

{% endblock %}